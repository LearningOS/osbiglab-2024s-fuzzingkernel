# Chapter 4

## 功能

- 重构 `sys_task_info` 与 `sys_get_time`
  - 实现了函数 `copy_to_raw`，可以将一个对象从内核地址空间复制到用户地址空间。
  - 获取 `TaskInfo` 和 `TimeVal` 的方法同前，之后调用 `copy_to_raw` 即可。
- `sys_mmap` 与 `sys_unmap`
  - 添加了内存错误类型 `MemoryError`，将众多可能 panic 的函数改为返回 `Result::Err(MemoryError)`，从而将错误处理下放到最基本的函数，且便于调用者灵活处理。
  - `sys_mmap` 通过调用 `MemorySet::insert_framed_area` 实现。该函数创建相应的 `MapArea` 并尝试在页表上建立映射，若已存在映射则会返回错误，由此可知系统调用是否成功。
  - `sys_unmap` 通过调用 `MemorySet::remove_framed_area` 实现。该函数首先检查要取消映射的地址区间中是否存在未建立页表映射的地址，若存在则报错。之后遍历地址空间的各个逻辑段，若与要取消的地址区间有交集，则将其拆分并移除交集。

## 简答

### Sv39 页表项

1. SV39 页表项包括：
   - [63:54]：保留
   - [53:28]：PPN2
   - [27:19]：PPN1
   - [18:10]：PPN0
   - [9:8]：保留
   - D (7)：Dirty，记录自从页表项上的这一位被清零之后，页表项的对应虚拟页表是否被修改过。
   - A (6)：Accessed，记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过。
   - G (5)：Global mapping，对于一个非叶节点的页表项，表示该节点及其子节点的记录应用于全局地址空间。
   - U (4)：User，表示该页表项对应虚拟页面是否在 CPU 处于 U 特权级的情况下是否被允许访问。
   - X (3)：Execute，表示该页表项对应虚拟页面是否允许被执行。
   - W (2)：Write，表示该页表项对应虚拟页面是否允许被写。
   - R (1)：Read，表示该页表项对应虚拟页面是否允许被读。
   - V (0)：Valid，表示该页表项是否有效。

### 缺页问题

1. 缺页产生的异常包括 Load access fault、Load page fault、Store/AMO access fault、Store/AMO page fault。
2. 发生缺页时，特殊的寄存器包括：
   - `stval`：记录产生异常的虚拟地址。
   - `sepc`：记录产生异常的指令地址。
   - `scause`、`sstatus`、`stvec`、`sscratch` 等寄存器的作用与一般的 Trap 处理相同。
3. Lazy 策略延后加载，可以节约当前的内存开销，使内存调度更自由；同时也可以避免频繁加载却没有使用（比如因为调用 `exec`）而造成的损失。
4. Sv39 中，每个页可以存放 4KB / 8B = 512 个页表项。叶节点（三级页表）需要 10GB / (4KB / 8B) = 20MB，二级页表需要 10GB / (4KB / 8B)^2 = 40KB，一级页表需要 10GB / (4KB / 8B)^3 = 80B，所以大约需要 20MB。
5. 实现上，mmap 只记录请求而不分配内存，访问时必会产生 page fault，处理异常时检查是否申请过相应内存，如果是则此时进行分配。
6. 页面失效时，页表项中的 V 位会被置 0。

### 双页表与单页表

1. 单页表下，内核中仍然需要维护每个进程的页表的根节点的物理页号，切换时更新 `satp` 即可。注意可能需要一些映射方式保证平滑过渡。
2. 单页表下，只需将内核页面页表项的 U 位置 0 即可。
3. 单页表在用户态和内核间切换时无需更新页表，开销较小，所以在频繁发生中断或异常的场景下效率更高。
4. 双页表下，进程间切换及用户程序和内核间切换均需要更换页表。单页表下，只有进程间切换才需要更换页表。

## Honor Code

- 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 **以下各位** 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

  > 无

- 此外，我也参考了 **以下资料** ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

  > 去年个人独立完成的实验：
  >
  > [李羽飞 / rCore-Tutorial-2023S · GitLab (tsinghua.edu.cn)](https://git.tsinghua.edu.cn/liyufei21/rcore-tutorial-2023s)
  >
  > [LearningOS/lab3-os5-nine-point-eight-p: lab3-os5-nine-point-eight-p created by GitHub Classroom](https://github.com/LearningOS/lab3-os5-nine-point-eight-p)

- 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

- 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。
